jQuery(function($) {
  const $chat = $('#cbn8n-chat');
  const $messages = $chat.find('.messages');
  const $input = $('#cbn8n-input');
  const $sendBtn = $('#cbn8n-send');

  /**
   * Envía el mensaje del usuario y gestiona la respuesta
   */
  function sendMessage() {
    const msg = $input.val().trim();
    if (!msg) return;

    // 1. Mostrar mensaje del usuario
    $messages.append(`<div class="msg user">${msg}</div>`);
    $input.val('');
    scrollToBottom();

    // 2. Llamada AJAX a WordPress
    $.post(CBN8N.ajax_url, {
      action: 'cbn8n_chat',
      nonce: CBN8N.nonce,
      mensaje: msg
    })
    .done(function(res) {
      if (res.success) {
        $messages.append(`<div class="msg bot">${res.data}</div>`);
      } else {
        $messages.append(`<div class="msg error">${res.data}</div>`);
      }
    })
    .fail(function() {
      $messages.append(`<div class="msg error">Error de red. Intenta nuevamente.</div>`);
    })
    .always(scrollToBottom);
  }

  /**
   * Desplaza el contenedor de mensajes al fondo
   */
  function scrollToBottom() {
    $messages.scrollTop($messages[0].scrollHeight);
  }

  // Envío al hacer clic en el botón
  $sendBtn.on('click', sendMessage);

  // Envío al presionar Enter en el input
  $input.on('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage();
    }
  });
});

jQuery(function($) {
  // 1. Crea el botón de cerrar y añádelo al chat
  const $chat = $('#cbn8n-chat');
  const $closeBtn = $('<button id="cbn8n-close" aria-label="Cerrar chat">×</button>')
    .css({
      position: 'absolute',
      top: '8px',
      right: '12px',
      background: 'transparent',
      border: 'none',
      'font-size': '1.5rem',
      cursor: 'pointer',
      color: '#fff',
      'z-index': 10
    })
    .appendTo($chat);

  // 2. Al hacer clic, oculta todo el contenedor fijo
  $closeBtn.on('click', function() {
    $('.cbn8n-fixed-container').hide();
  });

  // (Opcional) si quieres reabrirlo desde un botón externo:
  // jQuery('#mi-boton-abrir-chat').on('click', () => {
  //   $('.cbn8n-fixed-container').show();
  // });
});
